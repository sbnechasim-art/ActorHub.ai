# ActorHub Deployment Pipeline
# Deploys to production on release

name: Deploy

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================
  # Deploy to Staging
  # ===========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'staging' || github.event_name == 'release'
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to ECS
        run: |
          # Update ECS service with new image
          aws ecs update-service \
            --cluster actorhub-staging \
            --service api \
            --force-new-deployment

          aws ecs update-service \
            --cluster actorhub-staging \
            --service web \
            --force-new-deployment

          aws ecs update-service \
            --cluster actorhub-staging \
            --service worker \
            --force-new-deployment

      - name: Wait for deployment
        run: |
          aws ecs wait services-stable \
            --cluster actorhub-staging \
            --services api web worker

      - name: Run smoke tests
        run: |
          curl -f https://staging-api.actorhub.ai/health || exit 1
          curl -f https://staging.actorhub.ai || exit 1

      - name: Notify Slack
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Deployed to staging: ${{ github.sha }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===========================================
  # Deploy to Production
  # ===========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event.inputs.environment == 'production' || github.event_name == 'release'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Run database migrations
        run: |
          # Run migrations via ECS task
          aws ecs run-task \
            --cluster actorhub-production \
            --task-definition actorhub-migrations \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[${{ secrets.SUBNET_IDS }}],securityGroups=[${{ secrets.SECURITY_GROUP_ID }}]}"

      - name: Blue-Green Deployment
        run: |
          # Update CodeDeploy deployment group
          aws deploy create-deployment \
            --application-name actorhub-production \
            --deployment-group-name actorhub-production-dg \
            --revision '{"revisionType":"GitHub","gitHubLocation":{"repository":"${{ github.repository }}","commitId":"${{ github.sha }}"}}'

      - name: Wait for deployment
        run: |
          DEPLOYMENT_ID=$(aws deploy list-deployments \
            --application-name actorhub-production \
            --deployment-group-name actorhub-production-dg \
            --query 'deployments[0]' \
            --output text)

          aws deploy wait deployment-successful --deployment-id $DEPLOYMENT_ID

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: actorhub
          SENTRY_PROJECT: api
        with:
          environment: production
          version: ${{ github.sha }}

      - name: Notify Slack
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": ":rocket: Deployed to production: ${{ github.ref_name }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ===========================================
  # Post-Deployment Verification
  # ===========================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-production

    steps:
      - uses: actions/checkout@v4

      - name: Run E2E tests
        run: |
          npm ci
          npx playwright install --with-deps
          npx playwright test
        env:
          BASE_URL: https://actorhub.ai

      - name: Check API health
        run: |
          for i in {1..5}; do
            curl -f https://api.actorhub.ai/health && break
            sleep 10
          done

      - name: Check response times
        run: |
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' https://api.actorhub.ai/health)
          if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
            echo "Response time too slow: ${RESPONSE_TIME}s"
            exit 1
          fi
